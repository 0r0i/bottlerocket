#!/bin/bash

set -eu -o pipefail
shopt -qs failglob

for opt in "$@"; do
   optarg="$(expr "${opt}" : '[^=]*=\(.*\)')"
   case "${opt}" in
      --disk-image-name=*) DISK_IMAGE_NAME="${optarg}" ;;
      --boot-image-name=*) BOOT_IMAGE_NAME="${optarg}" ;;
      --root-image-name=*) ROOT_IMAGE_NAME="${optarg}" ;;
      --package-dir=*) PACKAGE_DIR="${optarg}" ;;
      --output-dir=*) OUTPUT_DIR="${optarg}" ;;
   esac
done

mkdir -p "${OUTPUT_DIR}"
rm -f "${OUTPUT_DIR}/${DISK_IMAGE_NAME}" "${OUTPUT_DIR}/${BOOT_IMAGE_NAME}" "${OUTPUT_DIR}/${ROOT_IMAGE_NAME}"

DISK_IMAGE="$(mktemp)"
BOOT_IMAGE="$(mktemp)"
ROOT_IMAGE="$(mktemp)"
DATA_IMAGE="$(mktemp)"
ROOT_MOUNT="/mnt/root"

# Define partition type GUIDs for all OS-managed partitions. This is required
# for the boot partition, where we set gptprio bits in the GUID-specific use
# field, but we might as well do it for all of them.
THAR_BOOT_TYPECODE="6b636168-7420-6568-2070-6c616e657421"
THAR_HASH_TYPECODE="598f10af-c955-4456-6a99-7720068a6cea"
THAR_ROOT_TYPECODE="5526016a-1a97-4ea4-b39a-b7c8c6ca4502"
THAR_RESERVED_TYPECODE="0c5d99a5-d331-4147-baef-08e2b855bdc9"
# This partition UUID is referenced in var-lib-thar.mount
THAR_DATA_PARTUUID="b9be5c1d-18f9-4f76-afe0-1119a3b1bbf6"

truncate -s 2G "${DISK_IMAGE}"
# boot partition attributes (-A): 48 = gptprio priority bit; 56 = gptprio successful bit
# partitions are backwards so that we don't make things inconsistent when specifying a wrong end sector :)
sgdisk --clear \
   -n 10:1024M:2047M -c 10:"THAR-DATA" -t 10:8300 -u 10:"${THAR_DATA_PARTUUID}" \
   -n 9:937M:0 -c 9:"THAR-RESERVED-B" -t 9:"${THAR_RESERVED_TYPECODE}" \
   -n 8:537M:0 -c 8:"THAR-ROOT-B" -t 8:"${THAR_ROOT_TYPECODE}" \
   -n 7:533M:0 -c 7:"THAR-HASH-B" -t 7:"${THAR_HASH_TYPECODE}" \
   -n 6:513M:0 -c 6:"THAR-BOOT-B" -t 6:"${THAR_BOOT_TYPECODE}" -A 6:"clear":48 -A 6:"clear":56 \
   -n 5:426M:0 -c 5:"THAR-RESERVED-A" -t 5:"${THAR_RESERVED_TYPECODE}" \
   -n 4:26M:0 -c 4:"THAR-ROOT-A" -t 4:"${THAR_ROOT_TYPECODE}" \
   -n 3:22M:0 -c 3:"THAR-HASH-A" -t 3:"${THAR_HASH_TYPECODE}" \
   -n 2:2M:0 -c 2:"THAR-BOOT-A" -t 2:"${THAR_BOOT_TYPECODE}" -A 2:"set":48 -A 2:"set":56 \
   -n 1:1M:0 -c 1:"BIOS-BOOT" -t 1:ef02 \
   --print "${DISK_IMAGE}"

mkdir -p "${ROOT_MOUNT}"
rpm -iv --root "${ROOT_MOUNT}" "${PACKAGE_DIR}"/*.rpm
rm -rf "${ROOT_MOUNT}"/var/lib

# MBR and BIOS-BOOT
echo "(hd0) ${DISK_IMAGE}" > ${ROOT_MOUNT}/boot/grub/device.map
"${ROOT_MOUNT}/sbin/grub-bios-setup" \
  --directory="${ROOT_MOUNT}/boot/grub" \
  --device-map="${ROOT_MOUNT}/boot/grub/device.map" \
  --root="hd0" \
  --skip-fs-probe \
  ${DISK_IMAGE}

rm -f "${ROOT_MOUNT}/boot/grub/*" "${ROOT_MOUNT}/sbin/grub*"

# Now that we're done messing with /, move /boot out of it
BOOT_MOUNT="/mnt/boot"
mkdir "${BOOT_MOUNT}"
mv "${ROOT_MOUNT}/boot"/* "${BOOT_MOUNT}"

# THAR-ROOT-A
mkfs.ext4 -O ^has_journal -d "${ROOT_MOUNT}" "${ROOT_IMAGE}" 400M
dd if="${ROOT_IMAGE}" of="${DISK_IMAGE}" conv=notrunc bs=512 seek=53248

# write GRUB config
cat <<EOF > ${BOOT_MOUNT}/grub/grub.cfg
set default="0"
set timeout="0"

menuentry "Thar" {
   linux (\$root)/vmlinuz root=PARTUUID=\$boot_uuid/PARTNROFF=2 ro console=tty0 console=ttyS0 systemd.log_target=console audit=0 init=/sbin/preinit
}
EOF

# THAR-BOOT-A
mkfs.ext4 -O ^has_journal -d "${BOOT_MOUNT}" "${BOOT_IMAGE}" 20M
dd if="${BOOT_IMAGE}" of="${DISK_IMAGE}" conv=notrunc bs=512 seek=4096

# THAR-DATA
mkfs.ext4 "${DATA_IMAGE}" 1023M
dd if="${DATA_IMAGE}" of="${DISK_IMAGE}" conv=notrunc,sparse bs=512 seek=2097152

sgdisk -v "${DISK_IMAGE}"

mv "${DISK_IMAGE}" "${OUTPUT_DIR}/${DISK_IMAGE_NAME}"
lz4 -9vc "${BOOT_IMAGE}" >"${OUTPUT_DIR}/${BOOT_IMAGE_NAME}"
lz4 -9vc "${ROOT_IMAGE}" >"${OUTPUT_DIR}/${ROOT_IMAGE_NAME}"
chown 1000:1000 "${OUTPUT_DIR}/${DISK_IMAGE_NAME}" "${OUTPUT_DIR}/${BOOT_IMAGE_NAME}" "${OUTPUT_DIR}/${ROOT_IMAGE_NAME}"
