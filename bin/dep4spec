#!/bin/bash

set -euo pipefail

for opt in "$@"; do
   optarg="$(expr "${opt}" : '[^=]*=\(.*\)')"
   case "${opt}" in
      --spec=*) SPEC="${optarg}" ;;
   esac
done

DIR="${SPEC%/*}"
PKG="${SPEC##*/}"
PKG="${PKG%.*}"

# For now we only support putting source-level dependencies in place.
# TODO: extend this to also deal with moving blobs around for third-party
# packages, since that's super painful right now.

PROJECT="workspaces/${PKG}"
[ -s "${PROJECT}/Cargo.toml" ] || exit 0

FILES="$(git ls-files ${PROJECT} | tr '\n' ' ')"
CRATE="${PKG}.crate"

# Build the initial crate to satisfy the other dependency generators.
tar czf ${DIR}/${CRATE} --transform="s,${PROJECT},${PKG}," ${FILES}

# Emit a rule to rebuild the crate if its dependencies change.
cat <<EOF
${DIR}/${CRATE} : ${FILES}
	@tar czf \$@ --transform='s,${PROJECT},${PKG},' ${FILES}
EOF
