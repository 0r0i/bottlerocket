#!/bin/bash

set -euo pipefail

for opt in "$@"; do
   optarg="$(expr "${opt}" : '[^=]*=\(.*\)')"
   case "${opt}" in
      --spec=*) SPEC="${optarg}" ;;
      --arch=*) ARCH="${optarg}" ;;
   esac
done

PKG="${SPEC##*/}"
PKG="${PKG%.*}"

MACROS="/usr/lib/rpm/macros:macros/${ARCH}:macros/shared:macros/rust:macros/cargo"
RPMSPEC=("rpmspec" "--macros" "${MACROS}" "--define" "_sourcedir packages/${PKG}")

# Collect file-based targets for the outputs of a package build.
RPMS="$("${RPMSPEC[@]}" --query \
           --queryformat="\$(OUTPUT)/%{NAME}-%{VERSION}-%{RELEASE}.%{ARCH}.rpm " "${SPEC}")"
RPMS="${RPMS%"${RPMS##*[![:space:]]}"}"

# Collect file-based targets needed as inputs of a package build.
SOURCE_LINES="$("${RPMSPEC[@]}" --parse "${SPEC}" | awk '/^Source/ {print $NF}')"
SOURCE_URLS="$(awk '$0 ~ "^https?://" {print}' <<<"${SOURCE_LINES}")"
SOURCES="$(awk -v pkg="${PKG}" -F / '{printf "packages/%s/%s ",pkg,$NF}' <<<"${SOURCE_LINES}")"
SOURCES="${SOURCES%"${SOURCES##*[![:space:]]}"}"

PATCHES="$("${RPMSPEC[@]}" --parse "${SPEC}" \
              | awk -v pkg="${PKG}" -F '[/ ]' '/^Patch/ {printf "packages/%s/%s ",pkg,$NF}')"
PATCHES="${PATCHES%"${PATCHES##*[![:space:]]}"}"

# Collect package-level dependencies needed as inputs of a package build.
BUILDREQUIRES="$("${RPMSPEC[@]}" --query --buildrequires "${SPEC}" \
                    | awk '/thar/ {printf "$(%s) ",$0} END {print ""}')"
BUILDREQUIRES="${BUILDREQUIRES%"${BUILDREQUIRES##*[![:space:]]}"}"

echo "${RPMS} : build-${PKG}-${ARCH}"
echo -e "\t@:\n"
echo -e ".INTERMEDIATE: build-${PKG}-${ARCH}\n"
echo "build-${PKG}-${ARCH} : ${SPEC} ${SOURCES} ${PATCHES} ${BUILDREQUIRES}"
echo -e "\t\$(call build_rpm,$PKG,${ARCH},\$^)\n"

for url in ${SOURCE_URLS}; do
    FILENAME="${url##*/}"
    if grep -q '^https://crates.io/api/v1/crates/[^/]\+/[^/]\+/download' <<<"$url"; then
        CHECKSUM="$(awk -F / '{print $1}' <<<"${url##*#}")"
    elif [[ -f "packages/${PKG}/sources" ]]; then
        CHECKSUM="$(awk -v filename="(${FILENAME})" '$2 == filename {print $4}' "packages/${PKG}/sources")"
    else
        echo -e "# download rule for packages/${PKG}/${FILENAME} couldn't be generated\n" 1>&2
        exit 1
    fi
    echo "SOURCES += packages/${PKG}/${FILENAME}"
    echo "packages/${PKG}/${FILENAME} :"
    echo -e "\t@\$(FETCH_UPSTREAM) \"${url}\" \"packages/${PKG}/${FILENAME}\" \"${CHECKSUM}\"\n"
done
