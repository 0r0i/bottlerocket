#!/bin/bash

set -euo pipefail

for opt in "$@"; do
   optarg="$(expr "${opt}" : '[^=]*=\(.*\)')"
   case "${opt}" in
      --spec=*) SPEC="${optarg}" ;;
      --arch=*) ARCH="${optarg}" ;;
   esac
done

PKG="${SPEC##*/}"
PKG="${PKG%.*}"

MACROS="/usr/lib/rpm/macros:macros/${ARCH}:macros/shared:macros/rust:macros/cargo"
RPMSPEC=("rpmspec" "--macros" "${MACROS}" "--define" "_sourcedir packages/${PKG}")

# Build-time dependencies are associated with all subpackages.
BUILDREQUIRES="$("${RPMSPEC[@]}" --query --buildrequires "${SPEC}" \
                    | awk '/thar/ {printf "$(%s) ",$0} END {print ""}')"
BUILDREQUIRES="${BUILDREQUIRES%"${BUILDREQUIRES##*[![:space:]]}"}"

# Emit variables for package names that resolve to both build and install dependencies.
"${RPMSPEC[@]}" --query \
   --queryformat="%{NAME} = \$(OUTPUT)/%{NAME}-%{VERSION}-%{RELEASE}.%{ARCH}.rpm[ \$(%{REQUIRES})] ${BUILDREQUIRES}\n" \
   "${SPEC}"

# Emit variables for package names that resolve to only install dependencies.
"${RPMSPEC[@]}" --query \
   --queryformat="%{NAME}-install = %{NAME}[ \$(%{REQUIRES}-install)]\n" \
   "${SPEC}"
